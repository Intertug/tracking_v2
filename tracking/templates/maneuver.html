{% extends 'layout/layout.html' %}
{% load staticfiles %}

{%block title%}Maniobras {{fleet}}{% endblock %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/country.css' %}">
{% endblock %}
{% block js %}
<script src="{% static 'js/zoomVessel.js' %}"></script>
{% endblock %}
{% block scripts %}
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBEuaoh_rW9edjj3Ona1XpY2yOk090mJ5o&amp;sensor=true"></script>
<script src="{% static 'js/markerclusterer.min.js' %}"></script>
{% endblock %}

{% block infotip %}
<div id="infotip-html">
    <p>Escoja una o varias Embarcaciones con la fecha-hora deseada de la lista para crear la maniobra</p>
</div>
{% endblock %}

{% block conection %}
<li role="presentation"><a href="/alerts/{{fleetId}}">Estados de Conexión</a></li>
{% endblock %}

{% block sidebarManeuver %}
<section class="sidebar">
    <a href="/country/{{fleetId}}">Atrás Flota</a>
    <form class="form sidebar__form" method="POST">
        {% csrf_token %}
        {% for vessel in vessels %}
        <div class="form__group">
            <input type="checkbox" id="{{vessel.vesselname|slugify}}" name="{{vessel.vesselname|slugify}}" value="{{vessel.vesselname|slugify}}" >
            <label for="{{vessel.vesselname|slugify}}">{{vessel.vesselname}}</label>
        </div>
        {% endfor %}
        <br/>
        <div class="form__group">
            <label for="dateone" class="control-label form__label">Fecha inicio: </label>
            <input required type="text" id="dateone" name="dateone" class="form-control form__date form__input" placeholder="{{dates.init}}" value="{{dates.init}}" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}">
        </div>
        <div class="form__group">
            <label for="datetwo" class="control-label form__label">Fecha final: </label>
            <input required type="text" id="datetwo" name="datetwo" class="form-control form__date form__input" placeholder="{{dates.final}}" value="{{dates.final}}" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}">
        </div>
        <input type="submit" class="btn form-control btn-success form__submit" value="Generar">
    </form>
</section>
{% endblock %}

{% block mapscriptManeuver %}
<section class="main">
    <div id="map-canvas" class="main__map"></div>
</section>
<script>
    var infoWindow = new google.maps.InfoWindow({
            content: ""
    })
    var markers = []
    var tugs = [
        {% for vs in vessels %}
            ["{{vs.vesselname}}", {{vs.lat}}, {{vs.long}}, 5,"<h6>{{vs.vesselname}}</h6> <b>Velocidad</b>: {{vs.speed}} Nudos<br/> <b>Fecha</b>: {{vs.gpsdate}} <br/><br/>", "{{vs.icon}}"],
        {% endfor %}
    ]
    {% if map.docks %}
    var platforms = [
        {% for p in map.platforms %}
        {
            icon: "{% static '' %}img/{{p.icon}}",
            center: new google.maps.LatLng({{p.center.0}}, {{p.center.1}}),
            name: "{{p.name}}"
        },
        {% endfor %}
    ]

    var docks = [
        {% for d in map.docks %}
        {
            icon: "{% static '' %}img/{{d.icon}}",
            center: new google.maps.LatLng({{d.center.0}}, {{d.center.1}}),
            name: "{{d.name}}"
        },
        {% endfor %}
    ]

    var points = [
        {% for circles in map.anchorages %}
        {
            center: new google.maps.LatLng({{circles.center.0}}, {{circles.center.1}}),
            radius: {{circles.radius}},
            html: "{{circles.name}}"
        },
        {% endfor %}
    ]

    var moorings = [
        {% for moor in map.moorings %}
        {
            path: [
            {% for area in moor.vertices %}
                   new google.maps.LatLng({{area.0}}, {{area.1}}),
            {% endfor %}
            ],
            html: "{{moor.name}}"
        },
        {% endfor %}
    ]
    {% endif %}

    var map = null

    function inicial(){
        var center = new google.maps.LatLng({{map.center.0}}, {{map.center.1}})
        var options = {
            zoom: {{map.zoom}},
            center: center,
            mapTypeId: google.maps.MapTypeId.{{map.mapType}},
            mapTypeControl: true,
            streetViewControl: false,
            scaleControl: true,
            mapTypeControlOptions: {
                position: google.maps.ControlPosition.RIGHT_TOP
            },
            zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_CENTER
            },
            panControlOptions: {
                position: google.maps.ControlPosition.RIGHT_CENTER
            },
            scaleControlOptions: {
                position: google.maps.ControlPosition.BOTTOM_CENTER
            }
        }
        map = new google.maps.Map(document.getElementById("map-canvas"), options)
        setMarkers(map, tugs)
        {% if map.docks %}
        setPlatforms(map, platforms)
        setDocks(map, docks)
        {% endif %}
        {% if map.cluster > 0 %}
        var mcOptions = {
            gridSize: {{map.cluster}},
            maxZoom: 12
        }
        var mc = new MarkerClusterer(map, markers, mcOptions)
        {% endif %}
        {% if map.docks %}
        for (var p in points) {
            var circleOptions = {
              strokeColor: '#FF0000',
              strokeOpacity: 0.7,
              strokeWeight: 1,
              fillColor: '#FF0000',
              fillOpacity: 0.40,
              map: map,
              center: points[p].center,
              radius: points[p].radius,
              html: points[p].html,
              zIndex: 1
            }
            var circle =  new google.maps.Circle(circleOptions)
            var infoWindowTemp = new google.maps.InfoWindow({
                size: new google.maps.Size(150,50)
            })
            google.maps.event.addListener(circle, 'click', function(event){
                var point = this.center
                infoWindowTemp.setContent(this.html)
                if(event){
                    point = event.latLng
                }
                infoWindowTemp.setPosition(point)
                infoWindowTemp.open(map)
            })
        }
        for (var i = 0; i < moorings.length; i++){
            mooringOpt = new google.maps.Polygon({
                paths: moorings[i]["path"],
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                html: moorings[i]["html"],
                zIndex: 1
            })
            var infoWindowTemp = new google.maps.InfoWindow({
                size: new google.maps.Size(150,50)
            })
            google.maps.event.addListener(mooringOpt, 'click', function(event){
                var point = this.getPath().getAt(0)
                infoWindowTemp.setContent(this.html)
                if(event){
                    point = event.latLng
                }
                infoWindowTemp.setPosition(point)
                infoWindowTemp.open(map)
            })
            mooringOpt.setMap(map)
        }
        {% endif %}
    }

    function setMarkers(map, vessels){
       for (var i = 0; i < vessels.length; i++){
            var tugs = vessels[i]
            var tugsLatLon = new google.maps.LatLng(tugs[1], tugs[2])
            var marker = new google.maps.Marker({
                position : tugsLatLon,
                map: map,
                icon: "{% static '' %}img/"+tugs[5],
                draggable: false,
                title: tugs[0],
                html: tugs[4],
                zIndex: 5
            })
            markers.push(marker)
            google.maps.event.addListener(marker, "mouseover", function () {
                infoWindow.setContent(this.html)
                infoWindow.open(map, this)
            })
            google.maps.event.addListener(marker, "mouseout", function(){
                infoWindow.close()
            })
       }
    }
    {% if map.docks %}
    function setPlatforms(map, platforms){
       for (var p in platforms){
            var marker = new google.maps.Marker({
                position: platforms[p].center,
                map: map,
                icon: platforms[p].icon,
                draggable: false,
                title: platforms[p].name,
                zIndex: 2,
                html: "<h6>" + platforms[p].name + "</h6>"
            })
            google.maps.event.addListener(marker, "mouseover", function () {
                infoWindow.setContent(this.html)
                infoWindow.open(map, this)
            })
            google.maps.event.addListener(marker, "mouseout", function () {
                infoWindow.close()
            })
       }
    }

    function setDocks(map, docks){
       for (var d in docks){
            var marker = new google.maps.Marker({
                position: docks[d].center,
                map: map,
                icon: docks[d].icon,
                draggable: false,
                title: docks[d].name,
                zIndex: 2,
                html: "<h6>" + docks[d].name + "</h6>"
            })
            google.maps.event.addListener(marker, "mouseover", function () {
                infoWindow.setContent(this.html)
                infoWindow.open(map, this)
            })
            google.maps.event.addListener(marker, "mouseout", function () {
                infoWindow.close()
            })
       }
    }
    {% endif %}
    google.maps.event.addDomListener(window, 'load', inicial)
</script>
{% endblock %}